<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Gi·ªè h√†ng c·ªßa b·∫°n</title>
    <style>
        body { font-family: "Inter", sans-serif; background: #f9fafb; color: #333; padding: 40px; }
        h2 { color: #e62222; text-align: center; margin-bottom: 25px; font-size: 28px; }

        .alert { color: #842029; background: #f8d7da; border: 1px solid #f5c2c7; padding: 10px 16px; border-radius: 8px; text-align: center; margin-bottom: 20px; }

        table { width: 100%; border-collapse: collapse; background: #fff; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border-radius: 10px; overflow: hidden; }
        th, td { padding: 14px 18px; text-align: center; }
        th { background: #e62222; color: white; text-transform: uppercase; font-weight: 600; font-size: 14px; }
        tr:not(:last-child) { border-bottom: 1px solid #f0f0f0; }

        .qty-control { display: inline-flex; align-items: center; gap: 6px; }
        .qty-btn { background: #e62222; color: white; border: none; width: 28px; height: 28px; border-radius: 50%; font-size: 18px; line-height: 1; cursor: pointer; }
        .qty-btn:hover { background: #c91616; }
        .qty-input { width: 40px; text-align: center; border: 1px solid #ccc; border-radius: 6px; height: 26px; }

        .remove { color: #c0392b; text-decoration: none; font-weight: bold; font-size: 18px; }
        .remove:hover { color: #e74c3c; }

        .total { text-align: right; margin-top: 20px; font-weight: bold; font-size: 18px; }
        .btn { background: #e62222; color: white; border: none; padding: 10px 22px; border-radius: 6px; cursor: pointer; text-decoration: none; font-size: 16px; transition: background 0.3s ease; }
        .btn:hover { background: #c91616; }

        .empty { text-align: center; color: #888; margin-top: 20px; font-size: 16px; }
    </style>
</head>
<body>

<h2>üõí Gi·ªè h√†ng c·ªßa b·∫°n</h2>

<div th:if="${error}" class="alert" th:text="${error}"></div>

<div th:if="${#lists.isEmpty(cartItems)}" class="empty">
    Gi·ªè h√†ng tr·ªëng. H√£y th√™m m√≥n ƒë·ªÉ th∆∞·ªüng th·ª©c nh√©!
</div>

<form th:action="@{/cart/checkout}" method="post" th:if="${!#lists.isEmpty(cartItems)}">
    <input type="hidden" name="restaurantId" th:value="${restaurantId}">

    <table>
        <thead>
        <tr>
            <th>T√™n m√≥n</th>
            <th>Gi√°</th>
            <th>S·ªë l∆∞·ª£ng</th>
            <th>Th√†nh ti·ªÅn</th>
            <th>Xo√°</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="item : ${cartItems}">
            <td th:text="${item.foodName}"></td>
            <td class="price" th:data-price="${item.price}" th:text="${#numbers.formatDecimal(item.price,0,'COMMA',0,'POINT')} + 'ƒë'"></td>

            <td>
                <div class="qty-control">
                    <button type="button" class="qty-btn" onclick="updateQuantity(this, -1)">‚àí</button>
                    <input type="text" class="qty-input" th:value="${item.quantity}" readonly>
                    <button type="button" class="qty-btn" onclick="updateQuantity(this, 1)">+</button>

                    <!-- Hidden inputs g·ª≠i v·ªÅ backend -->
                    <input type="hidden" name="foodIds" th:value="${item.foodId}" class="foodId">
                    <input type="hidden" name="quantities" th:value="${item.quantity}" class="quantity">
                </div>
            </td>

            <td class="subtotal" th:text="${#numbers.formatDecimal(item.price * item.quantity,0,'COMMA',0,'POINT')} + 'ƒë'"></td>
            <td><a th:href="@{'/cart/remove/' + ${item.foodId}}" class="remove">√ó</a></td>
        </tr>
        </tbody>
    </table>

    <div class="total">
        T·ªïng c·ªông: <span id="totalPrice" th:text="${#numbers.formatDecimal(total,0,'COMMA',0,'POINT')} + 'ƒë'"></span>
    </div>

    <div class="actions" style="text-align:right; margin-top:15px;">
        <button type="submit" class="btn">ƒê·∫∑t h√†ng ngay</button>
    </div>
</form>

<script>
    function updateQuantity(button, change) {
        const row = button.closest("tr");
        const input = row.querySelector(".qty-input");
        const hiddenInput = row.querySelector(".quantity");
        const price = parseInt(row.querySelector(".price").dataset.price);
        const subtotalCell = row.querySelector(".subtotal");

        let quantity = parseInt(input.value) + change;
        if (quantity < 1) quantity = 1;

        input.value = quantity;
        hiddenInput.value = quantity; // g·ª≠i v·ªÅ backend

        const subtotal = price * quantity;
        subtotalCell.textContent = subtotal.toLocaleString("vi-VN") + "ƒë";

        updateTotal();
    }

    function updateTotal() {
        let total = 0;
        document.querySelectorAll(".subtotal").forEach(td => {
            const value = parseInt(td.textContent.replace(/\D/g,''));
            total += value;
        });
        document.getElementById("totalPrice").textContent = total.toLocaleString("vi-VN") + "ƒë";
    }
</script>

</body>
</html>
