<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Đơn hàng nhà hàng</title>
  <th:block th:replace="~{common/template::library}"></th:block>
</head>
<body>
<div th:replace="~{common/template::headerRestaurant}"></div>

<div class="container py-4">
  <h2> Danh sách đơn hàng</h2>
  <table class="table table-bordered text-center align-middle">
    <thead class="table-light">
    <tr>
      <th>Mã đơn</th>
      <th>Khách hàng</th>
      <th>SĐT</th>
      <th>Ngày đặt</th>
      <th>Tổng tiền</th>
      <th>Trạng thái</th>
      <th>Hành động</th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="order : ${orders}">
      <td th:text="${order.id}"></td>
      <td th:text="${order.user.fullname}"></td>
      <td th:text="${order.user.phone != null ? order.user.phone : 'Chưa có'}"></td>
      <td th:text="${#temporals.format(order.createDate, 'dd/MM/yyyy HH:mm')}"></td>
      <td th:text="${#numbers.formatDecimal(order.totalPrice, 0, 'COMMA', 0, 'POINT')} + ' đ'"></td>

      <!-- Trạng thái -->
      <td>
        <span th:classappend="${order.status == 2} ? 'badge bg-success' :
                              (${order.status == 1} ? 'badge bg-warning text-dark' :
                              (${order.status == 3} ? 'badge bg-danger' : 'badge bg-secondary'))"
              th:text="${order.statusText}"></span>
      </td>

      <!-- Hành động -->
      <td>
        <div th:if="${order.status != 2 and order.status != 3}" class="d-flex gap-2 justify-content-center">
          <!-- ✅ Nút xác nhận -->
          <button type="button" class="btn btn-success btn-sm"
                  data-bs-toggle="modal"
                  data-bs-target="#confirmNextModal"
                  th:attr="data-id=${order.id}, data-name=${order.user.fullname}, data-status=${order.status}">
            <span th:text="${order.status == 0 ? '✅ Xác nhận' :
                            (order.status == 1 ? '✅ Hoàn thành' : '✅ Xác nhận')}"></span>
          </button>

          <!-- ❌ Nút hủy -->
          <button type="button" class="btn btn-danger btn-sm"
                  data-bs-toggle="modal"
                  data-bs-target="#cancelOrderModal"
                  th:attr="data-id=${order.id}, data-name=${order.user.fullname}">
            ❌ Hủy đơn
          </button>
        </div>
      </td>
    </tr>
    </tbody>
  </table>
</div>

<!-- ✅ Modal xác nhận chuyển trạng thái -->
<div class="modal fade" id="confirmNextModal" tabindex="-1" aria-labelledby="confirmNextLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-success">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title" id="confirmNextLabel">Xác nhận đơn hàng</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Đóng"></button>
      </div>
      <div class="modal-body">
        <p>Bạn có chắc muốn <strong id="nextActionText">chuyển trạng thái</strong> cho đơn hàng của <strong id="customerName"></strong> không?</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"> Hủy</button>
        <form id="nextForm" method="post">
          <button type="submit" class="btn btn-success"> Đồng ý</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- ❌ Modal xác nhận hủy -->
<div class="modal fade" id="cancelOrderModal" tabindex="-1" aria-labelledby="cancelOrderLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-danger">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="cancelOrderLabel">Hủy đơn hàng</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Đóng"></button>
      </div>
      <div class="modal-body">
        <p>Bạn có chắc muốn <strong>hủy</strong> đơn hàng của khách <strong id="cancelCustomerName"></strong> không?</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"> Quay lại</button>
        <form id="cancelForm" method="post">
          <button type="submit" class="btn btn-danger">Xác nhận hủy</button>
        </form>
      </div>
    </div>
  </div>
</div>

<div th:replace="~{common/template::footer}"></div>

<!-- ✅ Script xử lý modal -->
<script>
  // Modal xác nhận chuyển trạng thái
  const nextModal = document.getElementById('confirmNextModal');
  nextModal.addEventListener('show.bs.modal', event => {
    const button = event.relatedTarget;
    const id = button.getAttribute('data-id');
    const name = button.getAttribute('data-name');
    const status = parseInt(button.getAttribute('data-status'));

    const actionText = status === 0 ? 'xác nhận đơn' : 'đánh dấu hoàn thành';
    nextModal.querySelector('#nextActionText').textContent = actionText;
    nextModal.querySelector('#customerName').textContent = name;

    const form = nextModal.querySelector('#nextForm');
    form.action = `/restaurant/orders/${id}/next`;
  });

  // Modal hủy đơn
  const cancelModal = document.getElementById('cancelOrderModal');
  cancelModal.addEventListener('show.bs.modal', event => {
    const button = event.relatedTarget;
    const id = button.getAttribute('data-id');
    const name = button.getAttribute('data-name');

    cancelModal.querySelector('#cancelCustomerName').textContent = name;

    const form = cancelModal.querySelector('#cancelForm');
    form.action = `/restaurant/orders/${id}/cancel`;
  });
</script>
</body>
</html>
